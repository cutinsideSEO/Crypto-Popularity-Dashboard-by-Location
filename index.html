<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Popularity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0f0e0e;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        .header-text { color: #ea9c2f; }
        .card {
            background-color: #1f2324;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .country {
            transition: fill 0.3s ease;
            stroke: #0f0e0e;
            stroke-width: 0.5px;
        }
        .country:hover {
            fill: #ea9c2f;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            background: #2a2e2f;
            border: 1px solid #ea9c2f;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            color: #ffffff;
            z-index: 10;
        }
        .filter-checkbox:checked {
            background-color: #ea9c2f;
            border-color: #d68c24;
        }
        /* Chart.js Global Settings */
        Chart.defaults.color = '#ffffff';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = "'Inter', 'sans-serif'";
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-center w-full">
                <a href="https://zengo.com" target="_blank">
                    <img src="https://zengo.com/wp-content/uploads/ZenGo-Logo-Simple-5.svg" alt="ZenGo Logo" class="h-10 md:h-12 w-auto">
                </a>
                <a href="https://cutinside.com" target="_blank">
                    <img src="https://cutinside.com/llm-perception-tool/logo.png" alt="CutInside Logo" class="h-10 md:h-12 w-auto">
                </a>
            </div>
            <h1 class="header-text text-2xl md:text-4xl font-bold mt-4">Global Crypto Market Analysis</h1>
            <p class="text-gray-400 mt-2">Based on Monthly Organic Traffic to Websites</p>
        </header>

        <!-- Filters -->
        <div class="card p-4 mb-8">
            <h3 class="text-lg font-semibold mb-3 header-text">Filter by Platform</h3>
            <div id="platform-filters" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                <!-- Checkboxes will be generated by JS -->
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-400">Total Sampled Users</h3>
                <p id="total-users" class="header-text text-4xl font-bold mt-2">Loading...</p>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-400">Top Country</h3>
                <p id="top-country" class="header-text text-4xl font-bold mt-2">Loading...</p>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-400">Top Continent</h3>
                <p id="top-continent" class="header-text text-4xl font-bold mt-2">Loading...</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- World Map -->
            <div class="card lg:col-span-2 p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold mb-4 header-text">Crypto User Distribution</h2>
                <div id="map-container" class="relative w-full aspect-video">
                    <div id="loader" class="absolute inset-0 flex items-center justify-center">
                        <p>Loading Map...</p>
                    </div>
                    <div id="tooltip" class="tooltip"></div>
                </div>
            </div>

            <!-- Users by Continent -->
            <div class="card p-4 md:p-6 flex flex-col">
                <h2 class="text-xl md:text-2xl font-bold mb-4 header-text">Users by Continent</h2>
                <div class="flex-grow flex items-center justify-center h-64 md:h-auto">
                    <canvas id="continent-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Countries Chart -->
        <div class="card mt-8 p-4 md:p-6">
            <h2 class="text-xl md:text-2xl font-bold mb-4 header-text">All Countries by Monthly Organic User Count</h2>
            <div id="top-countries-container">
                 <canvas id="top-countries-chart"></canvas>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DATA AND CONFIGURATION ---
            const MAP_URL = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';
            const platforms = ['coinbase', 'kraken', 'metamask', 'crypto.com', 'binance'];
            let topCountriesChart, continentChart; // To hold chart instances

            // CSV data is embedded directly to avoid fetch/CORS errors.
            const csvData = `Location,coinbase,kraken,metamask,crypto.com,binance
United States,3100000,670100,156600,527600,1300000
India,1600000,54500,18200,360000,2000000
Brazil,607900,33100,21500,32900,834500
United Kingdom,675400,172900,21000,83100,196800
Pakistan,360200,22200,10500,45700,629400
Vietnam,36000,27700,10000,173700,747800
Turkey,105100,33800,30500,126300,644400
Canada,401200,161500,53800,125400,161200
Germany,459200,126100,21600,39300,213700
Indonesia,237400,22300,10400,122000,400000
France,319200,119300,20800,46600,263300
Nigeria,234800,11900,11900,117400,350000
Philippines,175000,17100,17100,113700,400000
Russian Federation,325100,44800,10600,24400,250000
Spain,228600,84500,11800,40400,159900
Mexico,221500,26500,15500,52000,150000
Argentina,168900,17000,10600,35800,150000
Netherlands,180300,112100,11300,23000,35000
Thailand,107100,12000,10500,42200,175000
Australia,176200,75000,12600,77300,0
Colombia,128800,16400,10500,35100,125000
Ukraine,119900,22800,10500,18000,125000
South Africa,139900,22500,10500,39300,50000
Poland,143400,53000,10500,22400,25000
Italy,252000,0,0,0,0
Malaysia,96900,10500,10500,41000,75000
Egypt,75900,10500,10500,29900,100000
Venezuela,78100,10500,10500,22100,100000
Bangladesh,72000,10500,10500,31700,80000
Romania,89500,35300,10500,15800,35000
Morocco,54000,10500,10500,18700,70000
Peru,69200,10500,10500,21100,50000
Belgium,83000,40900,10500,12100,10000
United Arab Emirates,51600,15700,10500,25000,35000
Singapore,47500,26900,10500,32300,10000
Chile,62900,10500,10500,17600,25000
Switzerland,65200,47700,10500,0,0
Sweden,66800,33200,10500,0,10000
Kazakhstan,48300,10500,10500,10500,35000
Japan,37900,37900,10500,20100,0
Austria,59000,33000,10500,0,0
Czechia,55400,24800,10500,0,0
Portugal,55300,24800,10500,0,0
Hong Kong,32500,17900,10500,20200,0
Saudi Arabia,15300,10500,10500,10500,25000
Greece,42400,16600,10500,0,0
Israel,53100,16600,0,0,0
Hungary,43300,17200,10500,0,0
Ireland,46500,27800,0,0,0
Denmark,40100,20300,10500,0,0
Norway,38100,20700,10500,0,0
Finland,33100,16700,10500,0,0
New Zealand,31200,16200,10500,0,0
Kenya,20200,10500,10500,10500,0
Ecuador,15900,10500,10500,10500,0
Bulgaria,27100,12100,0,0,0
Dominican Republic,15800,10500,10500,0,0
Serbia,25100,10500,0,0,0
Belarus,14900,10500,10500,0,0
Slovakia,22000,10500,0,0,0
Croatia,21400,10500,0,0,0
Guatemala,12800,10500,0,0,0
Lithuania,19100,0,0,0,0
Slovenia,16400,0,0,0,0
Uruguay,11900,0,0,0,0
Costa Rica,12700,0,0,0,0
Panama,11100,0,0,0,0
Latvia,13800,0,0,0,0
Estonia,13500,0,0,0,0
Georgia,10500,0,0,0,0
Cyprus,10500,0,0,0,0
Ghana,10500,0,0,0,0
Algeria,10500,0,0,0,0
Nepal,10500,0,0,0,0
Cambodia,10500,0,0,0,0
Tunisia,10500,0,0,0,0
Azerbaijan,10500,0,0,0,0
Sri Lanka,10500,0,0,0,0
Bolivia,10500,0,0,0,0
Paraguay,10500,0,0,0,0
El Salvador,10500,0,0,0,0
Qatar,10500,0,0,0,0
Lebanon,10500,0,0,0,0
Kuwait,10500,0,0,0,0
Oman,10500,0,0,0,0
Bahrain,10500,0,0,0,0
Jordan,10500,0,0,0,0
Albania,10500,0,0,0,0
Bosnia and Herzegovina,10500,0,0,0,0
North Macedonia,10500,0,0,0,0
Moldova,10500,0,0,0,0
Armenia,10500,0,0,0,0
Uzbekistan,10500,0,0,0,0
Kyrgyzstan,10500,0,0,0,0
Tajikistan,10500,0,0,0,0
Turkmenistan,10500,0,0,0,0
Afghanistan,10500,0,0,0,0
Iraq,10500,0,0,0,0
Syrian Arab Republic,10500,0,0,0,0
Yemen,10500,0,0,0,0
Libya,10500,0,0,0,0
Sudan,10500,0,0,0,0
Somalia,10500,0,0,0,0
Ethiopia,10500,0,0,0,0
Uganda,10500,0,0,0,0
Tanzania,10500,0,0,0,0
Zambia,10500,0,0,0,0
Angola,10500,0,0,0,0
Mozambique,10500,0,0,0,0
Madagascar,10500,0,0,0,0
Cameroon,10500,0,0,0,0
Cote d'Ivoire,10500,0,0,0,0
Senegal,10500,0,0,0,0
Mali,10500,0,0,0,0
Burkina Faso,10500,0,0,0,0
Niger,10500,0,0,0,0
Chad,10500,0,0,0,0
Guinea,10500,0,0,0,0
Benin,10500,0,0,0,0
Togo,10500,0,0,0,0
Sierra Leone,10500,0,0,0,0
Liberia,10500,0,0,0,0
Mauritania,10500,0,0,0,0
Gambia,10500,0,0,0,0
Guinea-Bissau,10500,0,0,0,0
Equatorial Guinea,10500,0,0,0,0
Sao Tome and Principe,10500,0,0,0,0
Cabo Verde,10500,0,0,0,0
Comoros,10500,0,0,0,0
Seychelles,10500,0,0,0,0
Mauritius,1800,292,207,290,2900
Honduras,1700,285,204,180,5500
Mongolia,1700,363,286,487,5700
Maldives,1600,228,2,1200,3100
Jamaica,1600,533,264,219,2500
Trinidad And Tobago,1300,342,211,373,3900
Namibia,1300,175,29,188,1800
"Palestine, State of",1100,214,174,174,10800
Rwanda,980,65,65,436,5800
Papua New Guinea,896,109,,88,717
Nicaragua,889,159,105,95,2500
Zimbabwe,608,173,187,113,2100
Congo,584,,,55,670
Haiti,579,97,62,114,2100
Gabon,555,42,,22,573
Belize,536,98,28,54,2
Brunei Darussalam,2800,134,58,138,900
Isle of Man,481,268,38,112,416
Andorra,366,163,108,59,841
Malawi,369,4,,43,1100
`;
            // Mapping from CSV country names to GeoJSON names
            const countryNameMapping = {
                "United States": "United States of America", "Russian Federation": "Russia", 
                "Czechia": "Czech Rep.", "Bosnia and Herzegovina": "Bosnia and Herz.", "North Macedonia": "Macedonia",
                "Syrian Arab Republic": "Syria", "Cote d'Ivoire": "CÃ´te d'Ivoire", "Cabo Verde": "Cape Verde",
                "Tanzania": "United Republic of Tanzania", "Dominican Republic": "Dominican Rep.", "Congo": "Congo",
                "Equatorial Guinea": "Eq. Guinea", "El Salvador": "El Salvador", "South Africa": "S. Africa",
                "Trinidad And Tobago": "Trinidad and Tobago", "Brunei Darussalam": "Brunei"
            };
            // Mapping countries to continents
            const continentMapping = {
                'Afghanistan': 'Asia', 'Angola': 'Africa', 'Albania': 'Europe', 'United Arab Emirates': 'Asia', 'Argentina': 'South America', 'Armenia': 'Asia', 'Antarctica': 'Antarctica', 'Australia': 'Oceania', 'Austria': 'Europe', 'Azerbaijan': 'Asia', 'Burundi': 'Africa', 'Belgium': 'Europe', 'Benin': 'Africa', 'Burkina Faso': 'Africa', 'Bangladesh': 'Asia', 'Bulgaria': 'Europe', 'Bahrain': 'Asia', 'Bahamas': 'North America', 'Bosnia and Herzegovina': 'Europe', 'Belarus': 'Europe', 'Belize': 'North America', 'Bolivia': 'South America', 'Brazil': 'South America', 'Brunei': 'Asia', 'Bhutan': 'Asia', 'Botswana': 'Africa', 'Central African Republic': 'Africa', 'Canada': 'North America', 'Switzerland': 'Europe', 'Chile': 'South America', 'China': 'Asia', "Cote d'Ivoire": 'Africa', 'Cameroon': 'Africa', 'Congo': 'Africa', 'Colombia': 'South America', 'Comoros': 'Africa', 'Cabo Verde': 'Africa', 'Costa Rica': 'North America', 'Cuba': 'North America', 'Cyprus': 'Europe', 'Czechia': 'Europe', 'Germany': 'Europe', 'Djibouti': 'Africa', 'Denmark': 'Europe', 'Dominican Republic': 'North America', 'Algeria': 'Africa', 'Ecuador': 'South America', 'Egypt': 'Africa', 'Eritrea': 'Africa', 'Spain': 'Europe', 'Estonia': 'Europe', 'Ethiopia': 'Africa', 'Finland': 'Europe', 'Fiji': 'Oceania', 'France': 'Europe', 'Gabon': 'Africa', 'United Kingdom': 'Europe', 'Georgia': 'Asia', 'Ghana': 'Africa', 'Guinea': 'Africa', 'Gambia': 'Africa', 'Guinea-Bissau': 'Africa', 'Equatorial Guinea': 'Africa', 'Greece': 'Europe', 'Greenland': 'North America', 'Guatemala': 'North America', 'Guyana': 'South America', 'Honduras': 'North America', 'Croatia': 'Europe', 'Haiti': 'North America', 'Hungary': 'Europe', 'Indonesia': 'Asia', 'India': 'Asia', 'Ireland': 'Europe', 'Iran': 'Asia', 'Iraq': 'Asia', 'Iceland': 'Europe', 'Israel': 'Asia', 'Italy': 'Europe', 'Jamaica': 'North America', 'Jordan': 'Asia', 'Japan': 'Asia', 'Kazakhstan': 'Asia', 'Kenya': 'Africa', 'Kyrgyzstan': 'Asia', 'Cambodia': 'Asia', 'Kuwait': 'Asia', 'Laos': 'Asia', 'Lebanon': 'Asia', 'Liberia': 'Africa', 'Libya': 'Africa', 'Sri Lanka': 'Asia', 'Lesotho': 'Africa', 'Lithuania': 'Europe', 'Luxembourg': 'Europe', 'Latvia': 'Europe', 'Morocco': 'Africa', 'Moldova': 'Europe', 'Madagascar': 'Africa', 'Mexico': 'North America', 'Macedonia': 'Europe', 'North Macedonia': 'Europe', 'Mali': 'Africa', 'Malta': 'Europe', 'Myanmar': 'Asia', 'Montenegro': 'Europe', 'Mongolia': 'Asia', 'Mozambique': 'Africa', 'Mauritania': 'Africa', 'Mauritius': 'Africa', 'Malawi': 'Africa', 'Malaysia': 'Asia', 'Namibia': 'Africa', 'Niger': 'Africa', 'Nigeria': 'Africa', 'Nicaragua': 'North America', 'Netherlands': 'Europe', 'Norway': 'Europe', 'Nepal': 'Asia', 'New Zealand': 'Oceania', 'Oman': 'Asia', 'Pakistan': 'Asia', 'Panama': 'North America', 'Peru': 'South America', 'Philippines': 'Asia', 'Papua New Guinea': 'Oceania', 'Poland': 'Europe', 'Portugal': 'Europe', 'Paraguay': 'South America', 'Qatar': 'Asia', 'Romania': 'Europe', 'Russia': 'Europe', 'Russian Federation': 'Europe', 'Rwanda': 'Africa', 'Saudi Arabia': 'Asia', 'Sudan': 'Africa', 'Senegal': 'Africa', 'Singapore': 'Asia', 'Solomon Islands': 'Oceania', 'Sierra Leone': 'Africa', 'El Salvador': 'North America', 'Somalia': 'Africa', 'Serbia': 'Europe', 'Slovakia': 'Europe', 'Slovenia': 'Europe', 'Sweden': 'Europe', 'Swaziland': 'Africa', 'Syria': 'Asia', 'Chad': 'Africa', 'Togo': 'Africa', 'Thailand': 'Asia', 'Tajikistan': 'Asia', 'Turkmenistan': 'Asia', 'Trinidad And Tobago': 'North America', 'Tunisia': 'Africa', 'Turkey': 'Asia', 'Tanzania': 'Africa', 'Uganda': 'Africa', 'Ukraine': 'Europe', 'Uruguay': 'South America', 'United States': 'North America', 'Uzbekistan': 'Asia', 'Venezuela': 'South America', 'Vietnam': 'Asia', 'Yemen': 'Asia', 'Zambia': 'Africa', 'Zimbabwe': 'Africa', "Palestine, State of": "Asia", "Brunei Darussalam": "Asia", "Isle of Man": "Europe", "Andorra": "Europe"
            };

            const tooltip = d3.select("#tooltip");
            let masterData = [];
            let world;

            // --- INITIALIZATION ---
            async function initialize() {
                try {
                    const rawData = d3.csvParse(csvData);
                    world = await d3.json(MAP_URL);

                    document.getElementById('loader').style.display = 'none';

                    masterData = rawData.map(d => {
                        const countryData = { Location: d.Location, continent: continentMapping[d.Location] || 'Other' };
                        platforms.forEach(p => {
                            countryData[p] = parseInt(d[p], 10) || 0;
                        });
                        return countryData;
                    });
                    
                    setupFilters();
                    updateDashboard();

                } catch (error) {
                    console.error("Error loading or processing data:", error);
                    document.getElementById('loader').innerText = 'Failed to load data.';
                }
            }

            // --- UI SETUP ---
            function setupFilters() {
                const filterContainer = document.getElementById('platform-filters');
                platforms.forEach(platform => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 cursor-pointer capitalize';
                    label.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-5 w-5 rounded text-orange-500 bg-gray-700 border-gray-600 focus:ring-orange-500 filter-checkbox" value="${platform}" checked>
                        <span>${platform.replace('.com', '')}</span>
                    `;
                    filterContainer.appendChild(label);
                });
                filterContainer.addEventListener('change', updateDashboard);
            }

            // --- DATA PROCESSING & DASHBOARD UPDATE ---
            function updateDashboard() {
                const selectedPlatforms = Array.from(document.querySelectorAll('#platform-filters input:checked')).map(el => el.value);

                const filteredData = masterData.map(d => {
                    const total = selectedPlatforms.reduce((sum, platform) => sum + d[platform], 0);
                    return { ...d, total };
                });

                const dataByCountry = new Map(filteredData.map(d => [d.Location, d]));

                updateMetrics(filteredData);
                updateMap(world, dataByCountry);
                updateTopCountriesChart(filteredData);
                updateContinentChart(filteredData);
            }

            function updateMetrics(data) {
                const totalUsers = data.reduce((sum, d) => sum + d.total, 0);
                document.getElementById('total-users').textContent = totalUsers.toLocaleString('en-US');

                const sortedByTotal = [...data].sort((a, b) => b.total - a.total);
                document.getElementById('top-country').textContent = sortedByTotal[0]?.Location || 'N/A';
                
                const continentTotals = data.reduce((acc, country) => {
                    if (country.continent && country.continent !== 'Other') {
                       acc[country.continent] = (acc[country.continent] || 0) + country.total;
                    }
                    return acc;
                }, {});

                const topContinent = Object.entries(continentTotals).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('top-continent').textContent = topContinent ? topContinent[0] : 'N/A';
            }

            // --- CHART & MAP RENDERING ---
            function updateMap(world, dataByCountry) {
                let svg = d3.select("#map-container svg");
                if (svg.empty()) { // If map is not yet drawn
                    const container = document.getElementById('map-container');
                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    svg = d3.select(container).append("svg")
                        .attr("viewBox", `0 0 ${width} ${height}`)
                        .attr("preserveAspectRatio", "xMidYMid meet")
                        .style("width", "100%").style("height", "100%");

                    const projection = d3.geoMercator().scale(width / 2 / Math.PI).translate([width / 2, height / 1.5]);
                    const path = d3.geoPath().projection(projection);
                    const countries = topojson.feature(world, world.objects.countries).features;

                    svg.selectAll("path.country")
                        .data(countries)
                        .enter().append("path")
                        .attr("class", "country")
                        .attr("d", path);
                    
                    const zoom = d3.zoom().scaleExtent([1, 8]).on('zoom', (event) => {
                        svg.selectAll('path').attr('transform', event.transform);
                    });
                    svg.call(zoom);
                }

                const maxUsers = d3.max(Array.from(dataByCountry.values()), d => d.total);
                const colorScale = d3.scaleLog().domain([1, maxUsers || 1]).range(["#4a5568", "#ea9c2f"]);

                svg.selectAll("path.country")
                    .attr("fill", d => {
                        const mappedName = Object.keys(countryNameMapping).find(key => countryNameMapping[key] === d.properties.name) || d.properties.name;
                        const countryData = dataByCountry.get(mappedName);
                        return countryData && countryData.total > 0 ? colorScale(countryData.total) : "#2d3748";
                    })
                    .on("mouseover", (event, d) => {
                        const mappedName = Object.keys(countryNameMapping).find(key => countryNameMapping[key] === d.properties.name) || d.properties.name;
                        const countryData = dataByCountry.get(mappedName);
                        tooltip.style("opacity", 1);
                        tooltip.html(`
                            <strong class="header-text">${d.properties.name}</strong><br>
                            Total Users: ${countryData ? countryData.total.toLocaleString('en-US') : 'No Data'}
                        `);
                    })
                    .on("mousemove", (event) => {
                        // Position tooltip closer to the cursor
                        tooltip.style("left", (event.pageX + 15) + "px")
                               .style("top", (event.pageY - 30) + "px");
                    })
                    .on("mouseout", () => tooltip.style("opacity", 0));
            }

            function updateTopCountriesChart(data) {
                const sortedData = [...data].sort((a, b) => b.total - a.total);
                const container = document.getElementById('top-countries-container');
                const ctx = document.getElementById('top-countries-chart').getContext('2d');
                
                // Dynamically set the height of the container based on the number of countries
                const newHeight = sortedData.length * 22; // 22px per bar
                container.style.height = `${newHeight}px`;

                if (topCountriesChart) { topCountriesChart.destroy(); }

                topCountriesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedData.map(d => d.Location),
                        datasets: [{
                            label: 'Total Users',
                            data: sortedData.map(d => d.total),
                            backgroundColor: '#ea9c2f',
                            borderColor: '#d68c24',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        scales: {
                            x: { grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { callback: value => {
                                    if (value >= 1000000) return (value / 1000000) + 'M';
                                    if (value >= 1000) return (value / 1000) + 'K';
                                    return value;
                                }}
                            },
                            y: { 
                                grid: { display: false },
                                ticks: {
                                    font: { size: 10 }
                                }
                            }
                        },
                        plugins: { legend: { display: false },
                            tooltip: { callbacks: { label: context => ` ${context.dataset.label}: ${context.raw.toLocaleString('en-US')}` } }
                        }
                    }
                });
            }

            function updateContinentChart(data) {
                const continentTotals = data.reduce((acc, country) => {
                    if (country.continent && country.continent !== 'Other') {
                        acc[country.continent] = (acc[country.continent] || 0) + country.total;
                    }
                    return acc;
                }, {});

                const sortedContinents = Object.entries(continentTotals).sort((a, b) => b[1] - a[1]);
                const ctx = document.getElementById('continent-chart').getContext('2d');

                if (continentChart) { continentChart.destroy(); }

                continentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedContinents.map(c => c[0]),
                        datasets: [{
                            data: sortedContinents.map(c => c[1]),
                            backgroundColor: ['#ea9c2f', '#d68c24', '#c07c1e', '#a96c18', '#935c12', '#7d4c0c'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { padding: 15 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.chart.getDatasetMeta(0).total;
                                        const percentage = ((value / total) * 100).toFixed(2) + '%';
                                        return ` ${label}: ${value.toLocaleString('en-US')} (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            initialize();
        });
    </script>
</body>
</html>
